<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Monitoring with Advanced Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }

        .header p {
            font-size: 1.1rem;
            color: #cbd5e1;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Card Base */
        .card {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: #3b82f6;
        }

        /* Control Buttons */
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .restore-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .clear-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Face Detection Section */
        .face-detection-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .face-detection-section {
                grid-template-columns: 1fr;
            }
        }

        /* Webcam Container */
        .webcam-container {
            position: relative;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            overflow: hidden;
            height: 320px;
            margin-bottom: 15px;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #canvas {
            width: 100%;
            height: 100%;
        }

        /* Webcam Controls */
        .webcam-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .webcam-btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }

        .start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .capture-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            grid-column: span 2;
        }

        .webcam-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .webcam-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.active {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ENHANCED REAL-TIME FEEDBACK SYSTEM */
        .feedback-container {
            margin-top: 20px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #f59e0b;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .feedback-header h3 {
            color: #f59e0b;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .feedback-stat {
            background: rgba(30, 41, 59, 0.8);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .feedback-messages {
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
        }

        .feedback-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .feedback-item.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .feedback-item.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .feedback-item.danger {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .feedback-item.info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .feedback-icon {
            font-size: 1.2rem;
            margin-right: 10px;
        }

        .feedback-content {
            flex: 1;
        }

        .feedback-time {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
        }

        .feedback-tip {
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #cbd5e1;
            border-left: 3px solid #8b5cf6;
        }

        /* IMPROVED EMOTION TRENDS CHARTS */
        .emotion-charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .emotion-charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            height: 350px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-header h3 {
            color: #e2e8f0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-stats {
            display: flex;
            gap: 15px;
        }

        .chart-stat {
            background: rgba(30, 41, 59, 0.8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-container {
            width: 100%;
            height: calc(100% - 50px);
            position: relative;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* GAMIFICATION SYSTEM */
        .gamification-container {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .gamification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .gamification-header h3 {
            color: #8b5cf6;
            font-size: 1.3rem;
        }

        .gamification-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .gamification-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .points-display {
            background: rgba(30, 41, 59, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .points-value {
            color: #fbbf24;
            font-size: 1.4rem;
        }

        /* Level System */
        .level-system {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #10b981;
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .level-header h4 {
            color: #10b981;
            font-size: 1.2rem;
        }

        .level-display {
            text-align: center;
        }

        .level-number {
            font-size: 3rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 10px;
        }

        .level-name {
            font-size: 1.1rem;
            color: #cbd5e1;
            margin-bottom: 15px;
        }

        .level-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }

        .level-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        /* ENHANCED ACHIEVEMENTS SECTION */
        .achievements-section {
            margin-bottom: 25px;
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .achievements-header h4 {
            color: #fbbf24;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .achievement-badge {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .achievement-badge.unlocked {
            border-color: #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
            to { box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
        }

        .achievement-badge.locked {
            opacity: 0.6;
            filter: grayscale(60%);
        }

        .achievement-badge.unlocked:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(251, 191, 36, 0.5);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .badge-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .badge-desc {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .badge-points {
            font-size: 0.8rem;
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .badge-progress {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Real-time Emotion Display */
        .emotion-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }

        .face-container {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .face-container::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.2), transparent 70%);
        }

        .detected-face {
            font-size: 5.5rem;
            transition: all 0.5s ease;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
        }

        .emotion-info {
            text-align: center;
            margin-top: 15px;
        }

        .emotion-label {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #f8fafc;
        }

        .emotion-description {
            font-size: 1rem;
            color: #cbd5e1;
            max-width: 500px;
            line-height: 1.5;
            min-height: 60px;
        }

        /* Emotion Meters */
        .emotion-meters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .emotion-meter {
            background: rgba(15, 23, 42, 0.7);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .meter-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meter-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .engagement-value {
            color: #10b981;
        }

        .frustration-value {
            color: #ef4444;
        }

        .meter-bar-container {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .meter-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .engagement-bar {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .frustration-bar {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        /* Stats Container */
        .stats-container {
            display: grid;
            grid-template-rows: auto auto;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.7);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #94a3b8;
        }
        
        .engagement-stat {
            color: #10b981;
        }
        
        .frustration-stat {
            color: #ef4444;
        }
        
        .balance-stat {
            color: #3b82f6;
        }
        
        .duration-stat {
            color: #8b5cf6;
        }

        /* Session Stats */
        .session-stats {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .session-stat {
            padding: 10px;
        }

        .session-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 5px;
        }

        .session-stat-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Data Log */
        .data-log {
            margin-top: 30px;
        }

        .log-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-item {
            background: rgba(30, 41, 59, 0.7);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .log-time {
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.8rem;
            min-width: 60px;
        }

        .log-emotion {
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            margin: 0 10px;
        }

        .log-values {
            display: flex;
            gap: 12px;
        }

        .log-engagement {
            color: #10b981;
        }

        .log-frustration {
            color: #ef4444;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #94a3b8;
            font-size: 0.85rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tech-icons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 15px 0;
            font-size: 1.3rem;
        }

        .tech-icons i {
            color: #3b82f6;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }

        /* Notification Animation */
        @keyframes achievementUnlock {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 20px;
            width: 350px;
            z-index: 1000;
            border-left: 6px solid #fbbf24;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: achievementUnlock 0.5s ease;
            display: none;
        }

        .notification-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            margin-bottom: 10px;
            text-align: center;
        }

        .notification-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .notification-message {
            text-align: center;
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .notification-points {
            text-align: center;
            color: #fbbf24;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Face Detection Error Modal */
        .face-error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .face-error-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 2px solid #ef4444;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .face-error-icon {
            font-size: 4rem;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .face-error-title {
            font-size: 1.8rem;
            color: #f8fafc;
            margin-bottom: 15px;
        }

        .face-error-message {
            font-size: 1.1rem;
            color: #cbd5e1;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .face-error-tips {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
        }

        .face-error-tips h4 {
            color: #f59e0b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .face-error-tips ul {
            list-style-type: none;
            padding-left: 10px;
        }

        .face-error-tips li {
            margin-bottom: 8px;
            color: #94a3b8;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .face-error-tips li i {
            color: #3b82f6;
            margin-top: 4px;
        }

        .face-error-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .face-error-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        /* Expression Guide */
        .expression-card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .expression-emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .expression-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #e2e8f0;
        }

        .expression-desc {
            font-size: 0.85rem;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-brain"></i> Advanced Emotion Monitoring System</h1>
            <p>Capture live photos to analyze emotions with enhanced analytics, achievements, and real-time feedback</p>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Column - Main Content -->
            <div>
                <!-- Face Detection Section -->
                <div class="face-detection-section">
                    <!-- Camera Section -->
                    <div class="card">
                        <h2><i class="fas fa-video"></i> Face Capture</h2>
                        <div class="webcam-container">
                            <video id="video" autoplay playsinline></video>
                            <div class="canvas-container">
                                <canvas id="canvas"></canvas>
                            </div>
                        </div>
                        
                        <div class="webcam-controls">
                            <button class="webcam-btn start-btn" id="startBtn">
                                <i class="fas fa-play"></i> Start Camera
                            </button>
                            <button class="webcam-btn stop-btn" id="stopBtn" disabled>
                                <i class="fas fa-stop"></i> Stop Camera
                            </button>
                            <button class="webcam-btn capture-btn" id="captureBtn" disabled>
                                <i class="fas fa-camera"></i> Capture & Analyze
                            </button>
                        </div>
                        
                        <div class="status-indicator">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="statusText">Camera Inactive</span>
                        </div>

                        <!-- Control Buttons -->
                        <div class="control-buttons">
                            <button class="control-btn restore-btn" id="restoreBtn">
                                <i class="fas fa-redo"></i> Restore Progress
                            </button>
                            <button class="control-btn export-btn" id="exportBtn">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="control-btn clear-btn" id="clearBtn">
                                <i class="fas fa-trash"></i> Clear Session
                            </button>
                        </div>

                        <!-- Session Stats -->
                        <div class="session-stats">
                            <div class="session-stat">
                                <div class="session-stat-value" id="sessionCaptures">0</div>
                                <div class="session-stat-label">Today's Captures</div>
                            </div>
                            <div class="session-stat">
                                <div class="session-stat-value" id="sessionTime">0m</div>
                                <div class="session-stat-label">Session Time</div>
                            </div>
                            <div class="session-stat">
                                <div class="session-stat-value" id="sessionPoints">0</div>
                                <div class="session-stat-label">Points Earned</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detected Emotional State -->
                    <div class="card">
                        <h2><i class="fas fa-user-circle"></i> Detected Emotional State</h2>
                        <div class="emotion-display">
                            <div class="face-container">
                                <div class="detected-face" id="detectedFace">üì∑</div>
                            </div>
                            <div class="emotion-info">
                                <div class="emotion-label" id="emotionLabel">Waiting for Capture</div>
                                <div class="emotion-description" id="emotionDescription">
                                    Start camera and capture a photo to analyze emotional state
                                </div>
                            </div>
                        </div>
                        
                        <div class="emotion-meters">
                            <div class="emotion-meter">
                                <div class="meter-header">
                                    <div class="meter-title">
                                        <i class="fas fa-brain"></i> Engagement
                                    </div>
                                    <div class="meter-value engagement-value" id="engagementValue">0%</div>
                                </div>
                                <div class="meter-bar-container">
                                    <div class="meter-bar engagement-bar" id="engagementBar" style="width: 0%"></div>
                                </div>
                                <div class="meter-labels">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <div class="emotion-meter">
                                <div class="meter-header">
                                    <div class="meter-title">
                                        <i class="fas fa-exclamation-triangle"></i> Frustration
                                    </div>
                                    <div class="meter-value frustration-value" id="frustrationValue">0%</div>
                                </div>
                                <div class="meter-bar-container">
                                    <div class="meter-bar frustration-bar" id="frustrationBar" style="width: 0%"></div>
                                </div>
                                <div class="meter-labels">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics -->
                        <div class="stats-container">
                            <div class="stats-row">
                                <div class="stat-card">
                                    <div class="stat-value engagement-stat" id="avgEngagement">0%</div>
                                    <div class="stat-label">Avg Engagement</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value frustration-stat" id="avgFrustration">0%</div>
                                    <div class="stat-label">Avg Frustration</div>
                                </div>
                            </div>
                            
                            <div class="stats-row">
                                <div class="stat-card">
                                    <div class="stat-value balance-stat" id="balanceScore">0%</div>
                                    <div class="stat-label">Balance Score</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value duration-stat" id="detectionTime">00:00</div>
                                    <div class="stat-label">Detection Time</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMPROVED EMOTION TRENDS CHARTS -->
                <div class="emotion-charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line" style="color: #10b981;"></i> Engagement Trends</h3>
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <i class="fas fa-arrow-up" style="color: #10b981;"></i>
                                    <span id="engagementHigh">Peak: 0%</span>
                                </div>
                                <div class="chart-stat">
                                    <i class="fas fa-bolt" style="color: #fbbf24;"></i>
                                    <span id="engagementAvg">Avg: 0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #10b981;"></div>
                                <span>Engagement Level</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(16, 185, 129, 0.2);"></div>
                                <span>Trend Area</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line" style="color: #ef4444;"></i> Frustration Trends</h3>
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <i class="fas fa-arrow-up" style="color: #ef4444;"></i>
                                    <span id="frustrationHigh">Peak: 0%</span>
                                </div>
                                <div class="chart-stat">
                                    <i class="fas fa-bolt" style="color: #fbbf24;"></i>
                                    <span id="frustrationAvg">Avg: 0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="frustrationChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ef4444;"></div>
                                <span>Frustration Level</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(239, 68, 68, 0.2);"></div>
                                <span>Trend Area</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ENHANCED REAL-TIME FEEDBACK SYSTEM -->
                <div class="card">
                    <div class="feedback-container">
                        <div class="feedback-header">
                            <h3><i class="fas fa-comment-dots"></i> Real-time Feedback & Tips</h3>
                            <div class="feedback-stats">
                                <div class="feedback-stat">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <span id="positiveFeedbacks">0</span>
                                </div>
                                <div class="feedback-stat">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                    <span id="warningFeedbacks">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="feedback-messages" id="feedbackMessages">
                            <div class="feedback-item info">
                                <div style="display: flex; align-items: flex-start;">
                                    <i class="fas fa-info-circle feedback-icon"></i>
                                    <div class="feedback-content">
                                        <strong>Welcome to Advanced Emotion Monitoring!</strong><br>
                                        Capture photos to receive personalized feedback based on your emotional state.
                                        <div class="feedback-time">System Ready</div>
                                    </div>
                                </div>
                                <div class="feedback-tip">
                                    üí° <strong>Tip:</strong> Try different facial expressions to see how the system responds!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emotion Data Log -->
                <div class="card data-log">
                    <h2><i class="fas fa-history"></i> Analysis History</h2>
                    <div style="color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> History of emotional states from captured photos
                    </div>
                    <div class="log-container" id="logContainer">
                        <div class="log-item">
                            <div class="log-time">--:--:--</div>
                            <div class="log-emotion">No captures yet</div>
                            <div class="log-values">
                                <span class="log-engagement">Eng: 0%</span>
                                <span class="log-frustration">Frus: 0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Gamification -->
            <div>
                <!-- GAMIFICATION SYSTEM -->
                <div class="card">
                    <div class="gamification-container">
                        <div class="gamification-header">
                            <h3><i class="fas fa-trophy"></i> Gamification System</h3>
                            <div class="points-display">
                                <i class="fas fa-star" style="color: #fbbf24;"></i>
                                <span class="points-value" id="totalPoints">0</span>
                                <span>Points</span>
                            </div>
                        </div>

                        <!-- Gamification Controls -->
                        <div class="gamification-controls">
                            <button class="gamification-btn" id="gamificationRestoreBtn">
                                <i class="fas fa-redo"></i> Restore Achievements
                            </button>
                        </div>

                        <!-- Level System -->
                        <div class="level-system">
                            <div class="level-header">
                                <h4><i class="fas fa-chart-line"></i> Learning Level</h4>
                                <span id="nextLevelPoints">0/100 XP</span>
                            </div>
                            <div class="level-display">
                                <div class="level-number" id="currentLevel">1</div>
                                <div class="level-name" id="levelName">Beginner Learner</div>
                                <div class="level-progress">
                                    <div class="level-progress-bar" id="levelProgressBar" style="width: 0%"></div>
                                </div>
                                <div class="level-stats">
                                    <span id="currentXP">0 XP</span>
                                    <span id="nextLevel">Level 2</span>
                                </div>
                            </div>
                        </div>

                        <!-- ENHANCED ACHIEVEMENTS SECTION -->
                        <div class="achievements-section">
                            <div class="achievements-header">
                                <h4><i class="fas fa-award"></i> Achievements</h4>
                                <span style="font-size: 0.9rem; color: #94a3b8;" id="achievementsCount">0/12 Unlocked</span>
                            </div>
                            <div class="achievements-grid" id="achievementsGrid">
                                <!-- Achievements will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expression Guide -->
                <div class="card">
                    <h2><i class="fas fa-smile"></i> Expression Guide</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                        <div class="expression-card">
                            <div class="expression-emoji">üòä</div>
                            <div class="expression-label">High Engagement</div>
                            <div class="expression-desc">Smile, open eyes, positive</div>
                        </div>
                        <div class="expression-card">
                            <div class="expression-emoji">üò†</div>
                            <div class="expression-label">High Frustration</div>
                            <div class="expression-desc">Frown, tense face, negative</div>
                        </div>
                        <div class="expression-card">
                            <div class="expression-emoji">üòê</div>
                            <div class="expression-label">Neutral</div>
                            <div class="expression-desc">Relaxed, normal expression</div>
                        </div>
                        <div class="expression-card">
                            <div class="expression-emoji">ü§î</div>
                            <div class="expression-label">Confused</div>
                            <div class="expression-desc">Tilted head, raised brows</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card">
                    <h2><i class="fas fa-chart-pie"></i> Quick Stats</h2>
                    <div class="stats-container">
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value engagement-stat" id="peakEngagement">0%</div>
                                <div class="stat-label">Peak Engagement</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value frustration-stat" id="peakFrustration">0%</div>
                                <div class="stat-label">Peak Frustration</div>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-value balance-stat" id="optimalCount">0</div>
                                <div class="stat-label">Optimal States</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value duration-stat" id="totalCaptures">0</div>
                                <div class="stat-label">Total Captures</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievement Notification -->
        <div class="achievement-notification" id="achievementNotification">
            <div class="notification-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="notification-title" id="notificationTitle">Achievement Unlocked!</div>
            <div class="notification-message" id="notificationMessage"></div>
            <div class="notification-points" id="notificationPoints">+50 Points!</div>
        </div>

        <!-- Face Detection Error Modal -->
        <div class="face-error-modal" id="faceErrorModal">
            <div class="face-error-content">
                <div class="face-error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="face-error-title">Face Not Detected Properly</div>
                <div class="face-error-message">
                    We're having trouble detecting your face clearly. This can affect the accuracy of emotion analysis.
                </div>
                
                <div class="face-error-tips">
                    <h4><i class="fas fa-lightbulb"></i> Troubleshooting Tips:</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Make sure your face is clearly visible in the frame</li>
                        <li><i class="fas fa-check"></i> Ensure good lighting on your face (avoid backlight)</li>
                        <li><i class="fas fa-check"></i> Position yourself closer to the camera</li>
                        <li><i class="fas fa-check"></i> Remove glasses or accessories that might obstruct your face</li>
                        <li><i class="fas fa-check"></i> Try different facial expressions</li>
                    </ul>
                </div>
                
                <button class="face-error-btn" id="closeFaceErrorBtn">
                    <i class="fas fa-check"></i> I Understand, Try Again
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="tech-icons">
                <i class="fas fa-camera" title="Live Photo Capture"></i>
                <i class="fas fa-smile" title="Facial Expression Analysis"></i>
                <i class="fas fa-chart-line" title="Advanced Analytics"></i>
                <i class="fas fa-trophy" title="Gamification System"></i>
            </div>
            <p>Advanced Emotion Monitoring System v4.0 | Enhanced Analytics & Achievements</p>
            <p style="margin-top: 5px; font-size: 0.8rem; color: #64748b;">Track emotional trends, unlock achievements, and optimize your learning experience!</p>
        </div>
    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const captureBtn = document.getElementById('captureBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const gamificationRestoreBtn = document.getElementById('gamificationRestoreBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const detectedFace = document.getElementById('detectedFace');
        const emotionLabel = document.getElementById('emotionLabel');
        const emotionDescription = document.getElementById('emotionDescription');
        const engagementValue = document.getElementById('engagementValue');
        const frustrationValue = document.getElementById('frustrationValue');
        const engagementBar = document.getElementById('engagementBar');
        const frustrationBar = document.getElementById('frustrationBar');
        const avgEngagement = document.getElementById('avgEngagement');
        const avgFrustration = document.getElementById('avgFrustration');
        const balanceScore = document.getElementById('balanceScore');
        const detectionTime = document.getElementById('detectionTime');
        const logContainer = document.getElementById('logContainer');
        const feedbackMessages = document.getElementById('feedbackMessages');
        const achievementsGrid = document.getElementById('achievementsGrid');
        const totalPoints = document.getElementById('totalPoints');
        const currentLevel = document.getElementById('currentLevel');
        const levelName = document.getElementById('levelName');
        const levelProgressBar = document.getElementById('levelProgressBar');
        const currentXP = document.getElementById('currentXP');
        const nextLevel = document.getElementById('nextLevel');
        const nextLevelPoints = document.getElementById('nextLevelPoints');
        const achievementNotification = document.getElementById('achievementNotification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationPoints = document.getElementById('notificationPoints');
        const positiveFeedbacks = document.getElementById('positiveFeedbacks');
        const warningFeedbacks = document.getElementById('warningFeedbacks');
        const sessionCaptures = document.getElementById('sessionCaptures');
        const sessionTime = document.getElementById('sessionTime');
        const sessionPoints = document.getElementById('sessionPoints');
        const achievementsCount = document.getElementById('achievementsCount');
        const peakEngagement = document.getElementById('peakEngagement');
        const peakFrustration = document.getElementById('peakFrustration');
        const optimalCount = document.getElementById('optimalCount');
        const totalCaptures = document.getElementById('totalCaptures');
        const engagementHigh = document.getElementById('engagementHigh');
        const engagementAvg = document.getElementById('engagementAvg');
        const frustrationHigh = document.getElementById('frustrationHigh');
        const frustrationAvg = document.getElementById('frustrationAvg');
        const faceErrorModal = document.getElementById('faceErrorModal');
        const closeFaceErrorBtn = document.getElementById('closeFaceErrorBtn');
        
        // State variables
        let isCameraActive = false;
        let stream = null;
        let detectionStartTime = null;
        let sessionStartTime = null;
        let analysisCount = 0;
        let totalEngagementSum = 0;
        let totalFrustrationSum = 0;
        let feedbackStats = { positive: 0, warning: 0 };
        let sessionPointsEarned = 0;
        let peakEngagementValue = 0;
        let peakFrustrationValue = 0;
        let optimalStatesCount = 0;
        let faceDetectionErrors = 0; // Track face detection errors
        
        // Chart variables
        let engagementChart = null;
        let frustrationChart = null;
        let engagementData = [];
        let frustrationData = [];
        let chartLabels = [];
        
        // GAME STATE with ENHANCED ACHIEVEMENTS
        let gameState = {
            points: 0,
            level: 1,
            xp: 0,
            xpToNextLevel: 100,
            captures: 0,
            highEngagementCount: 0,
            veryHighEngagementCount: 0,
            balancedCount: 0,
            lowFrustrationCount: 0,
            consistentCount: 0,
            rapidAnalyzerCount: 0,
            perfectBalanceCount: 0,
            emotionalMasterCount: 0,
            dataCollectorCount: 0,
            focusProCount: 0,
            zenMasterCount: 0,
            learningJourneyCount: 0,
            sessionCaptures: 0,
            achievements: {}
        };
        
        // ENHANCED ACHIEVEMENTS (12 Total)
        const achievements = [
            {
                id: 'first_capture',
                name: 'First Step',
                description: 'Capture your first photo',
                icon: 'fas fa-camera',
                points: 50,
                condition: (state) => state.captures >= 1,
                progress: (state) => Math.min(state.captures || 0, 1),
                maxProgress: 1
            },
            {
                id: 'engagement_master',
                name: 'Focus Master',
                description: 'Achieve 80%+ engagement 5 times',
                icon: 'fas fa-brain',
                points: 100,
                condition: (state) => (state.highEngagementCount || 0) >= 5,
                progress: (state) => Math.min(state.highEngagementCount || 0, 5),
                maxProgress: 5
            },
            {
                id: 'perfect_focus',
                name: 'Perfect Focus',
                description: 'Achieve 90%+ engagement 3 times',
                icon: 'fas fa-bullseye',
                points: 150,
                condition: (state) => (state.veryHighEngagementCount || 0) >= 3,
                progress: (state) => Math.min(state.veryHighEngagementCount || 0, 3),
                maxProgress: 3
            },
            {
                id: 'balanced_learner',
                name: 'Balanced Learner',
                description: 'Maintain balanced state (40-60%) 8 times',
                icon: 'fas fa-balance-scale',
                points: 120,
                condition: (state) => (state.balancedCount || 0) >= 8,
                progress: (state) => Math.min(state.balancedCount || 0, 8),
                maxProgress: 8
            },
            {
                id: 'zen_master',
                name: 'Zen Master',
                description: 'Keep frustration below 20% 5 times',
                icon: 'fas fa-spa',
                points: 200,
                condition: (state) => (state.lowFrustrationCount || 0) >= 5,
                progress: (state) => Math.min(state.lowFrustrationCount || 0, 5),
                maxProgress: 5
            },
            {
                id: 'consistent_analyzer',
                name: 'Consistent Analyzer',
                description: 'Analyze 5 consecutive photos',
                icon: 'fas fa-redo',
                points: 180,
                condition: (state) => (state.consistentCount || 0) >= 5,
                progress: (state) => Math.min(state.consistentCount || 0, 5),
                maxProgress: 5
            },
            {
                id: 'rapid_analyzer',
                name: 'Rapid Analyzer',
                description: 'Analyze 10 photos in one session',
                icon: 'fas fa-bolt',
                points: 220,
                condition: (state) => (state.rapidAnalyzerCount || 0) >= 10,
                progress: (state) => Math.min(state.rapidAnalyzerCount || 0, 10),
                maxProgress: 10
            },
            {
                id: 'perfect_balance',
                name: 'Perfect Balance',
                description: 'Achieve exactly 50% engagement 3 times',
                icon: 'fas fa-percentage',
                points: 250,
                condition: (state) => (state.perfectBalanceCount || 0) >= 3,
                progress: (state) => Math.min(state.perfectBalanceCount || 0, 3),
                maxProgress: 3
            },
            {
                id: 'emotional_master',
                name: 'Emotional Master',
                description: 'Experience all 5 emotional states',
                icon: 'fas fa-star',
                points: 300,
                condition: (state) => (state.emotionalMasterCount || 0) >= 5,
                progress: (state) => Math.min(state.emotionalMasterCount || 0, 5),
                maxProgress: 5
            },
            {
                id: 'data_collector',
                name: 'Data Collector',
                description: 'Collect 25 total captures',
                icon: 'fas fa-database',
                points: 350,
                condition: (state) => (state.captures || 0) >= 25,
                progress: (state) => Math.min(state.captures || 0, 25),
                maxProgress: 25
            },
            {
                id: 'focus_pro',
                name: 'Focus Pro',
                description: 'Maintain 70%+ engagement for 5 captures',
                icon: 'fas fa-chart-line',
                points: 280,
                condition: (state) => (state.focusProCount || 0) >= 5,
                progress: (state) => Math.min(state.focusProCount || 0, 5),
                maxProgress: 5
            },
            {
                id: 'learning_journey',
                name: 'Learning Journey',
                description: 'Reach level 5',
                icon: 'fas fa-graduation-cap',
                points: 400,
                condition: (state) => (state.level || 0) >= 5,
                progress: (state) => Math.min(state.level || 0, 5),
                maxProgress: 5
            }
        ];
        
        // Initialize game state
        function initGameState() {
            const saved = localStorage.getItem('emotionGameState');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState = {
                    points: parsed.points || 0,
                    level: parsed.level || 1,
                    xp: parsed.xp || 0,
                    xpToNextLevel: parsed.xpToNextLevel || 100,
                    captures: parsed.captures || 0,
                    highEngagementCount: parsed.highEngagementCount || 0,
                    veryHighEngagementCount: parsed.veryHighEngagementCount || 0,
                    balancedCount: parsed.balancedCount || 0,
                    lowFrustrationCount: parsed.lowFrustrationCount || 0,
                    consistentCount: parsed.consistentCount || 0,
                    rapidAnalyzerCount: parsed.rapidAnalyzerCount || 0,
                    perfectBalanceCount: parsed.perfectBalanceCount || 0,
                    emotionalMasterCount: parsed.emotionalMasterCount || 0,
                    dataCollectorCount: parsed.dataCollectorCount || 0,
                    focusProCount: parsed.focusProCount || 0,
                    zenMasterCount: parsed.zenMasterCount || 0,
                    learningJourneyCount: parsed.learningJourneyCount || 0,
                    sessionCaptures: 0,
                    achievements: parsed.achievements || {}
                };
            }
            updateGamificationDisplay();
            renderAchievements();
            initCharts();
            updatePerformanceStats();
        }
        
        // Save game state
        function saveGameState() {
            localStorage.setItem('emotionGameState', JSON.stringify(gameState));
        }
        
        // Restore gamification and achievements to default
        function restoreGamification() {
            if (confirm('Restore gamification system and achievements to default?\nThis will reset your points, level, and achievements.')) {
                // Reset game state to default
                gameState = {
                    points: 0,
                    level: 1,
                    xp: 0,
                    xpToNextLevel: 100,
                    captures: gameState.captures || 0, // Keep captures count
                    highEngagementCount: 0,
                    veryHighEngagementCount: 0,
                    balancedCount: 0,
                    lowFrustrationCount: 0,
                    consistentCount: 0,
                    rapidAnalyzerCount: 0,
                    perfectBalanceCount: 0,
                    emotionalMasterCount: 0,
                    dataCollectorCount: 0,
                    focusProCount: 0,
                    zenMasterCount: 0,
                    learningJourneyCount: 0,
                    sessionCaptures: 0,
                    achievements: {}
                };
                
                // Save to localStorage
                saveGameState();
                
                // Update display
                updateGamificationDisplay();
                renderAchievements();
                
                // Show notification
                showNotification(
                    'üîÑ Gamification Restored',
                    'Gamification system has been reset to default',
                    'Start fresh with your achievements!'
                );
            }
        }
        
        // Initialize IMPROVED charts
        function initCharts() {
            const engagementCtx = document.getElementById('engagementChart').getContext('2d');
            const frustrationCtx = document.getElementById('frustrationChart').getContext('2d');
            
            // Create initial labels
            chartLabels = Array.from({length: 15}, (_, i) => `#${i + 1}`);
            
            // Initialize with empty data
            engagementData = Array(15).fill(null);
            frustrationData = Array(15).fill(null);
            
            // IMPROVED Engagement Chart
            engagementChart = new Chart(engagementCtx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Engagement %',
                        data: engagementData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#10b981',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return `Engagement: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 25
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // IMPROVED Frustration Chart
            frustrationChart = new Chart(frustrationCtx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Frustration %',
                        data: frustrationData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#ef4444',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return `Frustration: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 25
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
        
        // Update charts with new data
        function updateCharts(engagement, frustration) {
            // Add new data to arrays
            engagementData.push(engagement);
            frustrationData.push(frustration);
            
            // Remove oldest data if we have more than 15 points
            if (engagementData.length > 15) {
                engagementData.shift();
                frustrationData.shift();
            }
            
            // Update labels
            chartLabels = [];
            for (let i = 1; i <= engagementData.length; i++) {
                chartLabels.push(`#${i}`);
            }
            
            // Update engagement chart
            engagementChart.data.labels = chartLabels;
            engagementChart.data.datasets[0].data = engagementData;
            
            // Update frustration chart
            frustrationChart.data.labels = chartLabels;
            frustrationChart.data.datasets[0].data = frustrationData;
            
            // Calculate and update chart stats
            const engAvg = engagementData.filter(v => v !== null).reduce((a, b) => a + b, 0) / engagementData.filter(v => v !== null).length || 0;
            const frusAvg = frustrationData.filter(v => v !== null).reduce((a, b) => a + b, 0) / frustrationData.filter(v => v !== null).length || 0;
            const engMax = Math.max(...engagementData.filter(v => v !== null));
            const frusMax = Math.max(...frustrationData.filter(v => v !== null));
            
            engagementHigh.textContent = `Peak: ${Math.round(engMax)}%`;
            engagementAvg.textContent = `Avg: ${Math.round(engAvg)}%`;
            frustrationHigh.textContent = `Peak: ${Math.round(frusMax)}%`;
            frustrationAvg.textContent = `Avg: ${Math.round(frusAvg)}%`;
            
            // Refresh charts with animation
            engagementChart.update('active');
            frustrationChart.update('active');
        }
        
        // Start camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                captureBtn.disabled = false;
                isCameraActive = true;
                statusDot.classList.add('active');
                statusText.textContent = 'Camera Active';
                
                detectionStartTime = new Date();
                sessionStartTime = new Date();
                
                // Reset session stats
                sessionPointsEarned = 0;
                sessionPoints.textContent = '0';
                sessionCaptures.textContent = '0';
                faceDetectionErrors = 0;
                
                const firstLog = logContainer.firstChild;
                if (firstLog && firstLog.textContent.includes('No captures yet')) {
                    logContainer.innerHTML = '';
                }
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                statusText.textContent = 'Camera Error';
                alert('Please allow camera access to use face detection feature.');
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            captureBtn.disabled = true;
            isCameraActive = false;
            statusDot.classList.remove('active');
            statusText.textContent = 'Camera Inactive';
            
            detectedFace.textContent = 'üì∑';
            emotionLabel.textContent = 'Camera Stopped';
            emotionDescription.textContent = 'Start camera to capture and analyze photos';
        }
        
        // Capture and analyze photo
        function captureAndAnalyze() {
            if (!isCameraActive) return;
            
            const ctx = canvas.getContext('2d');
            const width = video.videoWidth;
            const height = video.videoHeight;
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(video, 0, 0, width, height);
            
            // Simulate face detection - in real app this would be ML model
            const faceDetected = simulateFaceDetection();
            
            if (!faceDetected) {
                faceDetectionErrors++;
                showFaceDetectionError();
                return null;
            }
            
            drawFaceDetectionOverlay(ctx, width, height);
            
            const result = analyzeFacialExpression();
            
            updateDetectionTime();
            updateSessionStats();
            
            return result;
        }
        
        // Simulate face detection (with 20% error rate for demonstration)
        function simulateFaceDetection() {
            // In a real application, this would use a face detection ML model
            // For demonstration, we'll simulate occasional face detection failures
            const errorRate = 0.2; // 20% chance of face detection error
            
            // Increase error rate after multiple consecutive errors
            const adjustedErrorRate = faceDetectionErrors > 0 ? errorRate * (1 + faceDetectionErrors * 0.3) : errorRate;
            
            // Reset error count if we successfully detect a face
            if (Math.random() > adjustedErrorRate) {
                faceDetectionErrors = 0;
                return true;
            } else {
                return false;
            }
        }
        
        // Show face detection error modal
        function showFaceDetectionError() {
            faceErrorModal.style.display = 'flex';
            
            // Add error feedback
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            
            const feedbackItem = document.createElement('div');
            feedbackItem.className = 'feedback-item danger';
            feedbackItem.innerHTML = `
                <div style="display: flex; align-items: flex-start;">
                    <i class="fas fa-exclamation-triangle feedback-icon"></i>
                    <div class="feedback-content">
                        <strong>Face Detection Issue</strong><br>
                        Unable to detect face clearly. This affects analysis accuracy.
                        <div class="feedback-time">${timeString}</div>
                    </div>
                </div>
                <div class="feedback-tip">
                    üö® <strong>Action:</strong> Adjust your position and lighting, then try again.
                </div>
            `;
            
            feedbackMessages.insertBefore(feedbackItem, feedbackMessages.firstChild);
            
            // Update warning feedback stats
            feedbackStats.warning++;
            warningFeedbacks.textContent = feedbackStats.warning;
            
            // Limit to 5 feedback messages
            if (feedbackMessages.children.length > 5) {
                feedbackMessages.removeChild(feedbackMessages.lastChild);
            }
        }
        
        // Close face detection error modal
        function closeFaceErrorModal() {
            faceErrorModal.style.display = 'none';
        }
        
        // Draw face detection overlay
        function drawFaceDetectionOverlay(ctx, width, height) {
            const boxWidth = 200 + Math.random() * 100;
            const boxHeight = 250 + Math.random() * 100;
            const boxX = (width - boxWidth) / 2;
            const boxY = (height - boxHeight) / 2;
            
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
            
            ctx.fillStyle = '#ef4444';
            
            ctx.beginPath();
            ctx.arc(boxX + boxWidth * 0.3, boxY + boxHeight * 0.35, 8, 0, Math.PI * 2);
            ctx.arc(boxX + boxWidth * 0.7, boxY + boxHeight * 0.35, 8, 0, Math.PI * 2);
            ctx.fill();
            
            const mouthCurve = Math.random() > 0.5 ? 0 : Math.PI;
            ctx.beginPath();
            ctx.arc(boxX + boxWidth * 0.5, boxY + boxHeight * 0.7, 15, mouthCurve, Math.PI + mouthCurve);
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.fillStyle = '#3b82f6';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Face Detected', boxX, boxY - 10);
        }
        
        // Analyze facial expression
        function analyzeFacialExpression() {
            const patterns = [
                { eng: 85, frus: 15 },
                { eng: 70, frus: 30 },
                { eng: 50, frus: 50 },
                { eng: 30, frus: 70 },
                { eng: 15, frus: 85 }
            ];
            
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            const variation = Math.floor(Math.random() * 11) - 5;
            const engagement = Math.max(0, Math.min(100, pattern.eng + variation));
            const frustration = 100 - engagement;
            
            updateEmotionDisplay(engagement, frustration);
            
            analysisCount++;
            totalEngagementSum += engagement;
            totalFrustrationSum += frustration;
            updateStatistics();
            
            // Update session captures
            gameState.sessionCaptures++;
            sessionCaptures.textContent = gameState.sessionCaptures;
            
            // Update game state and get points earned
            const pointsEarned = updateGameState(engagement, frustration);
            sessionPointsEarned += pointsEarned;
            
            // Update performance stats
            updatePerformanceStats(engagement, frustration);
            
            // Add enhanced feedback
            addEnhancedFeedback(engagement, frustration);
            
            // Update charts
            updateCharts(engagement, frustration);
            
            logAnalysis(engagement, frustration);
            
            return { engagement, frustration, pointsEarned };
        }
        
        // Update emotion display
        function updateEmotionDisplay(engagement, frustration) {
            engagementValue.textContent = engagement + '%';
            frustrationValue.textContent = frustration + '%';
            engagementBar.style.width = engagement + '%';
            frustrationBar.style.width = frustration + '%';
            
            let faceIcon = 'üòê';
            let label = 'Neutral';
            let description = 'Balanced emotional state detected.';
            
            if (engagement >= 90) {
                faceIcon = 'ü§©';
                label = 'Extremely Engaged';
                description = 'Exceptional focus and engagement level!';
            } else if (engagement >= 80) {
                faceIcon = 'üòä';
                label = 'Highly Engaged';
                description = 'Strong positive engagement detected!';
            } else if (engagement >= 60) {
                faceIcon = 'üôÇ';
                label = 'Engaged';
                description = 'Good engagement level. Positive learning state.';
            } else if (engagement >= 40) {
                faceIcon = 'üòê';
                label = 'Neutral';
                description = 'Balanced emotional state.';
            } else if (engagement >= 20) {
                faceIcon = 'üòï';
                label = 'Frustrated';
                description = 'Signs of frustration detected.';
            } else {
                faceIcon = 'üò†';
                label = 'Highly Frustrated';
                description = 'High frustration level detected.';
            }
            
            detectedFace.textContent = faceIcon;
            emotionLabel.textContent = label;
            emotionDescription.textContent = description;
        }
        
        // Update statistics
        function updateStatistics() {
            if (analysisCount === 0) return;
            
            const avgEng = totalEngagementSum / analysisCount;
            const avgFrus = totalFrustrationSum / analysisCount;
            const balance = Math.max(0, Math.min(100, avgEng - avgFrus + 50));
            
            avgEngagement.textContent = Math.round(avgEng) + '%';
            avgFrustration.textContent = Math.round(avgFrus) + '%';
            balanceScore.textContent = Math.round(balance) + '%';
        }
        
        // Update performance stats
        function updatePerformanceStats(engagement = 0, frustration = 0) {
            // Update peak values
            if (engagement > peakEngagementValue) {
                peakEngagementValue = engagement;
                peakEngagement.textContent = Math.round(peakEngagementValue) + '%';
            }
            
            if (frustration > peakFrustrationValue) {
                peakFrustrationValue = frustration;
                peakFrustration.textContent = Math.round(peakFrustrationValue) + '%';
            }
            
            // Count optimal states (engagement 60-80)
            if (engagement >= 60 && engagement <= 80) {
                optimalStatesCount++;
                optimalCount.textContent = optimalStatesCount;
            }
            
            // Update total captures
            totalCaptures.textContent = gameState.captures;
        }
        
        // Update detection time
        function updateDetectionTime() {
            if (!detectionStartTime) return;
            
            const now = new Date();
            const diffMs = now - detectionStartTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffSecs = Math.floor((diffMs % 60000) / 1000);
            
            detectionTime.textContent = 
                diffMins.toString().padStart(2, '0') + ':' + 
                diffSecs.toString().padStart(2, '0');
        }
        
        // Update session stats
        function updateSessionStats() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const diffMs = now - sessionStartTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            sessionTime.textContent = `${diffMins}m`;
            sessionPoints.textContent = sessionPointsEarned;
        }
        
        // Enhanced feedback system
        function addEnhancedFeedback(engagement, frustration) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            
            let feedback = {
                type: 'info',
                icon: 'fas fa-info-circle',
                title: 'Analysis Complete',
                message: 'Your emotional state has been analyzed.',
                tip: 'Keep capturing photos to track your progress!',
                time: timeString
            };
            
            if (engagement >= 90) {
                feedback = {
                    type: 'success',
                    icon: 'fas fa-crown',
                    title: 'Exceptional Focus!',
                    message: 'You\'re at peak engagement level - perfect for complex tasks!',
                    tip: 'üí° <strong>Tip:</strong> Use this high-focus state for difficult problems or creative work.',
                    time: timeString
                };
                feedbackStats.positive++;
            } else if (engagement >= 80) {
                feedback = {
                    type: 'success',
                    icon: 'fas fa-check-circle',
                    title: 'Excellent Engagement',
                    message: 'You\'re highly engaged and focused.',
                    tip: 'üí° <strong>Tip:</strong> This is ideal for learning new concepts.',
                    time: timeString
                };
                feedbackStats.positive++;
            } else if (engagement >= 60) {
                feedback = {
                    type: 'success',
                    icon: 'fas fa-thumbs-up',
                    title: 'Good Learning State',
                    message: 'You\'re engaged and making good progress.',
                    tip: 'üí° <strong>Tip:</strong> Maintain this state by taking short breaks every 25 minutes.',
                    time: timeString
                };
                feedbackStats.positive++;
            } else if (frustration >= 80) {
                feedback = {
                    type: 'danger',
                    icon: 'fas fa-exclamation-triangle',
                    title: 'High Frustration Alert',
                    message: 'You\'re experiencing significant frustration.',
                    tip: 'üö® <strong>Action:</strong> Take a 5-minute break, stretch, or try a different approach.',
                    time: timeString
                };
                feedbackStats.warning++;
            } else if (frustration >= 70) {
                feedback = {
                    type: 'warning',
                    icon: 'fas fa-exclamation-circle',
                    title: 'Elevated Frustration',
                    message: 'Frustration levels are rising.',
                    tip: '‚ö†Ô∏è <strong>Tip:</strong> Try breaking the task into smaller, manageable steps.',
                    time: timeString
                };
                feedbackStats.warning++;
            } else if (engagement <= 30) {
                feedback = {
                    type: 'warning',
                    icon: 'fas fa-low-vision',
                    title: 'Low Engagement Detected',
                    message: 'You might be feeling disengaged or distracted.',
                    tip: 'üîÑ <strong>Tip:</strong> Change your environment or try a different learning method.',
                    time: timeString
                };
                feedbackStats.warning++;
            } else if (Math.abs(engagement - 50) <= 10) {
                feedback = {
                    type: 'info',
                    icon: 'fas fa-balance-scale',
                    title: 'Optimal Balance',
                    message: 'Perfect balance between challenge and comfort.',
                    tip: 'üéØ <strong>Tip:</strong> This is the ideal state for sustained learning.',
                    time: timeString
                };
            }
            
            const feedbackItem = document.createElement('div');
            feedbackItem.className = `feedback-item ${feedback.type}`;
            feedbackItem.innerHTML = `
                <div style="display: flex; align-items: flex-start;">
                    <i class="${feedback.icon} feedback-icon"></i>
                    <div class="feedback-content">
                        <strong>${feedback.title}</strong><br>
                        ${feedback.message}
                        <div class="feedback-time">${timeString}</div>
                    </div>
                </div>
                <div class="feedback-tip">
                    ${feedback.tip}
                </div>
            `;
            
            feedbackMessages.insertBefore(feedbackItem, feedbackMessages.firstChild);
            
            // Update feedback stats
            positiveFeedbacks.textContent = feedbackStats.positive;
            warningFeedbacks.textContent = feedbackStats.warning;
            
            // Limit to 5 feedback messages
            if (feedbackMessages.children.length > 5) {
                feedbackMessages.removeChild(feedbackMessages.lastChild);
            }
        }
        
        // Update game state with ENHANCED achievements
        function updateGameState(engagement, frustration) {
            // Update captures count
            gameState.captures = (gameState.captures || 0) + 1;
            
            // Update achievement counters
            if (engagement >= 80) {
                gameState.highEngagementCount = (gameState.highEngagementCount || 0) + 1;
            }
            
            if (engagement >= 90) {
                gameState.veryHighEngagementCount = (gameState.veryHighEngagementCount || 0) + 1;
            }
            
            if (Math.abs(engagement - 50) <= 10) { // Balanced state (40-60%)
                gameState.balancedCount = (gameState.balancedCount || 0) + 1;
            }
            
            if (frustration <= 20) {
                gameState.lowFrustrationCount = (gameState.lowFrustrationCount || 0) + 1;
            }
            
            // Update consecutive captures
            gameState.consistentCount = (gameState.consistentCount || 0) + 1;
            
            // Update session rapid analyzer
            if (gameState.sessionCaptures >= 10) {
                gameState.rapidAnalyzerCount = Math.max(gameState.rapidAnalyzerCount || 0, gameState.sessionCaptures);
            }
            
            // Perfect balance achievement
            if (engagement === 50) {
                gameState.perfectBalanceCount = (gameState.perfectBalanceCount || 0) + 1;
            }
            
            // Emotional master (track different states)
            if (engagement >= 90) gameState.emotionalMasterCount = Math.max(gameState.emotionalMasterCount || 0, 5);
            else if (engagement >= 80) gameState.emotionalMasterCount = Math.max(gameState.emotionalMasterCount || 0, 4);
            else if (engagement >= 60) gameState.emotionalMasterCount = Math.max(gameState.emotionalMasterCount || 0, 3);
            else if (engagement >= 40) gameState.emotionalMasterCount = Math.max(gameState.emotionalMasterCount || 0, 2);
            else gameState.emotionalMasterCount = Math.max(gameState.emotionalMasterCount || 0, 1);
            
            // Focus pro (track consecutive high engagement)
            if (engagement >= 70) {
                gameState.focusProCount = (gameState.focusProCount || 0) + 1;
            } else {
                gameState.focusProCount = 0;
            }
            
            // Calculate base points
            let pointsEarned = 0;
            if (engagement >= 90) {
                pointsEarned = 40;
            } else if (engagement >= 80) {
                pointsEarned = 30;
            } else if (engagement >= 60) {
                pointsEarned = 25;
            } else if (engagement >= 40) {
                pointsEarned = 20;
            } else {
                pointsEarned = 15;
            }
            
            // Bonus for low frustration
            if (frustration <= 20) {
                pointsEarned += 20;
            }
            
            // Bonus for balanced state
            if (Math.abs(engagement - 50) <= 10) {
                pointsEarned += 15;
            }
            
            // Bonus for perfect balance
            if (engagement === 50) {
                pointsEarned += 25;
            }
            
            gameState.points += pointsEarned;
            gameState.xp += pointsEarned;
            
            // Check level up
            checkLevelUp();
            
            // Check achievements
            checkAchievements();
            
            // Update display
            updateGamificationDisplay();
            
            // Save state
            saveGameState();
            
            return pointsEarned;
        }
        
        // Check level up
        function checkLevelUp() {
            while (gameState.xp >= gameState.xpToNextLevel) {
                gameState.xp -= gameState.xpToNextLevel;
                gameState.level++;
                gameState.xpToNextLevel = Math.floor(gameState.xpToNextLevel * 1.5);
                
                // Show level up notification
                showNotification(
                    'üéâ Level Up!',
                    `You've reached Level ${gameState.level}!`,
                    '+1 Level'
                );
            }
        }
        
        // Check ENHANCED achievements
        function checkAchievements() {
            let unlockedCount = 0;
            
            achievements.forEach(achievement => {
                if (!gameState.achievements[achievement.id]) {
                    const isUnlocked = achievement.condition(gameState);
                    if (isUnlocked) {
                        // Unlock achievement
                        gameState.achievements[achievement.id] = true;
                        gameState.points += achievement.points;
                        unlockedCount++;
                        
                        // Show achievement notification
                        showNotification(
                            'üèÜ Achievement Unlocked!',
                            achievement.name,
                            `+${achievement.points} Points`
                        );
                    }
                } else {
                    unlockedCount++;
                }
            });
            
            // Update achievements count
            achievementsCount.textContent = `${unlockedCount}/${achievements.length} Unlocked`;
            
            // Update achievements display
            if (unlockedCount > Object.keys(gameState.achievements).length) {
                renderAchievements();
                updateGamificationDisplay();
            }
        }
        
        // Update gamification display
        function updateGamificationDisplay() {
            // Update points
            totalPoints.textContent = gameState.points;
            
            // Update level display
            currentLevel.textContent = gameState.level;
            
            // Update level name
            const levelNames = [
                'Beginner Learner', 'Novice Analyst', 'Skilled Observer',
                'Proficient Monitor', 'Expert Evaluator', 'Master Analyst',
                'Grandmaster', 'Legendary Analyst', 'Emotion Sage', 'Zen Master'
            ];
            const levelIndex = Math.min(gameState.level - 1, levelNames.length - 1);
            levelName.textContent = levelNames[levelIndex];
            
            // Update XP progress
            const progressPercentage = (gameState.xp / gameState.xpToNextLevel) * 100;
            levelProgressBar.style.width = `${progressPercentage}%`;
            
            // Update XP text
            currentXP.textContent = `${gameState.xp} XP`;
            nextLevel.textContent = `Level ${gameState.level + 1}`;
            nextLevelPoints.textContent = `${gameState.xp}/${gameState.xpToNextLevel} XP`;
        }
        
        // Render ENHANCED achievements
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const isUnlocked = gameState.achievements[achievement.id] || false;
                const progress = achievement.progress ? achievement.progress(gameState) : 0;
                const maxProgress = achievement.maxProgress || 1;
                const progressPercent = (progress / maxProgress) * 100;
                
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
                badge.setAttribute('data-id', achievement.id);
                badge.innerHTML = `
                    <div class="badge-icon">
                        <i class="${achievement.icon}"></i>
                    </div>
                    <div class="badge-name">${achievement.name}</div>
                    <div class="badge-desc">${achievement.description}</div>
                    <div class="badge-points">${achievement.points} pts</div>
                    ${!isUnlocked ? `
                        <div class="badge-progress">
                            <div class="progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="progress-text">${progress}/${maxProgress}</div>
                    ` : `
                        <div class="progress-text" style="color: #fbbf24; font-weight: bold;">‚úì UNLOCKED</div>
                    `}
                `;
                
                badge.addEventListener('click', () => {
                    showNotification(
                        isUnlocked ? 'üèÜ Achievement Unlocked!' : 'üîí Locked Achievement',
                        achievement.name,
                        isUnlocked ? `+${achievement.points} Points Awarded` : `Progress: ${progress}/${maxProgress}`
                    );
                });
                
                achievementsGrid.appendChild(badge);
            });
        }
        
        // Show notification
        function showNotification(title, message, points) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationPoints.textContent = points;
            
            achievementNotification.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                achievementNotification.style.display = 'none';
            }, 5000);
        }
        
        // Log analysis
        function logAnalysis(engagement, frustration) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            let emotion = 'Neutral';
            if (engagement >= 90) emotion = 'Extremely Engaged';
            else if (engagement >= 80) emotion = 'Highly Engaged';
            else if (engagement >= 60) emotion = 'Engaged';
            else if (engagement >= 40) emotion = 'Neutral';
            else if (engagement >= 20) emotion = 'Frustrated';
            else emotion = 'Highly Frustrated';
            
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <div class="log-time">${timeString}</div>
                <div class="log-emotion">${emotion}</div>
                <div class="log-values">
                    <span class="log-engagement">Eng: ${engagement}%</span>
                    <span class="log-frustration">Frus: ${frustration}%</span>
                </div>
            `;
            
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            if (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
            
            logItem.style.opacity = '0';
            logItem.style.transform = 'translateY(-8px)';
            
            setTimeout(() => {
                logItem.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                logItem.style.opacity = '1';
                logItem.style.transform = 'translateY(0)';
            }, 10);
        }
        
        // Restore progress function
        function restoreProgress() {
            if (confirm('Restore all saved progress and achievements?')) {
                initGameState();
                showNotification(
                    'üîÑ Progress Restored',
                    'All your saved progress has been restored!',
                    'Continue where you left off'
                );
            }
        }
        
        // Export data function
        function exportData() {
            const data = {
                gameState: gameState,
                stats: {
                    totalCaptures: gameState.captures,
                    peakEngagement: peakEngagementValue,
                    peakFrustration: peakFrustrationValue,
                    optimalStates: optimalStatesCount,
                    averageEngagement: totalEngagementSum / analysisCount || 0,
                    averageFrustration: totalFrustrationSum / analysisCount || 0
                },
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `emotion-monitoring-data-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(
                'üì• Data Exported',
                'Your emotion monitoring data has been downloaded',
                'Check your downloads folder'
            );
        }
        
        // Clear session function
        function clearSession() {
            if (confirm('Clear current session data? This will reset session stats but keep your progress.')) {
                // Reset session variables
                analysisCount = 0;
                totalEngagementSum = 0;
                totalFrustrationSum = 0;
                feedbackStats = { positive: 0, warning: 0 };
                sessionPointsEarned = 0;
                gameState.sessionCaptures = 0;
                faceDetectionErrors = 0;
                
                // Reset charts
                engagementData = Array(15).fill(null);
                frustrationData = Array(15).fill(null);
                chartLabels = Array.from({length: 15}, (_, i) => `#${i + 1}`);
                
                // Update charts
                engagementChart.data.labels = chartLabels;
                engagementChart.data.datasets[0].data = engagementData;
                frustrationChart.data.labels = chartLabels;
                frustrationChart.data.datasets[0].data = frustrationData;
                engagementChart.update();
                frustrationChart.update();
                
                // Reset UI
                sessionCaptures.textContent = '0';
                sessionPoints.textContent = '0';
                sessionTime.textContent = '0m';
                positiveFeedbacks.textContent = '0';
                warningFeedbacks.textContent = '0';
                avgEngagement.textContent = '0%';
                avgFrustration.textContent = '0%';
                balanceScore.textContent = '0%';
                peakEngagement.textContent = '0%';
                peakFrustration.textContent = '0%';
                optimalCount.textContent = '0';
                
                // Clear feedback messages (keep first one)
                while (feedbackMessages.children.length > 1) {
                    feedbackMessages.removeChild(feedbackMessages.lastChild);
                }
                
                // Clear log
                logContainer.innerHTML = '';
                
                showNotification(
                    'üóëÔ∏è Session Cleared',
                    'Current session data has been cleared',
                    'Your progress is saved'
                );
            }
        }
        
        // Event Listeners
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        captureBtn.addEventListener('click', captureAndAnalyze);
        restoreBtn.addEventListener('click', restoreProgress);
        exportBtn.addEventListener('click', exportData);
        clearBtn.addEventListener('click', clearSession);
        gamificationRestoreBtn.addEventListener('click', restoreGamification);
        closeFaceErrorBtn.addEventListener('click', closeFaceErrorModal);
        
        // Close modal when clicking outside
        faceErrorModal.addEventListener('click', (e) => {
            if (e.target === faceErrorModal) {
                closeFaceErrorModal();
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initGameState();
            
            // Update timers
            setInterval(() => {
                if (isCameraActive) {
                    updateDetectionTime();
                    updateSessionStats();
                }
            }, 1000);
        });
    </script>
</body>
</html>